var C=Object.defineProperty;var p=(h,t,s)=>t in h?C(h,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):h[t]=s;var i=(h,t,s)=>(p(h,typeof t!="symbol"?t+"":t,s),s);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))e(a);new MutationObserver(a=>{for(const n of a)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&e(o)}).observe(document,{childList:!0,subtree:!0});function s(a){const n={};return a.integrity&&(n.integrity=a.integrity),a.referrerpolicy&&(n.referrerPolicy=a.referrerpolicy),a.crossorigin==="use-credentials"?n.credentials="include":a.crossorigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function e(a){if(a.ep)return;a.ep=!0;const n=s(a);fetch(a.href,n)}})();class w{constructor(t){i(this,"wsRegion");i(this,"wsClicks");i(this,"wsMask");i(this,"viewer");i(this,"receivedMask");this.viewer=t,this.wsRegion=new WebSocket("ws://localhost:8001/ws/region"),this.wsClicks=new WebSocket("ws://localhost:8001/ws/clicks"),this.wsMask=new WebSocket("ws://localhost:8001/ws/mask"),this.wsMask.binaryType="arraybuffer",this.receivedMask=new Uint8ClampedArray(0),this.wsMask.onmessage=this.receiveMask.bind(this)}sendClicks(t){this.wsClicks.send(JSON.stringify(t))}sendRegion(t,s,e){this.wsRegion.send(JSON.stringify({dx:t,dy:s,zoom:e}))}receiveMask(t){console.log("receiving mask"),this.receivedMask=this.decodeMask(t);const s=new ImageData(this.receivedMask,Math.floor(this.viewer.imgWidth),Math.floor(this.viewer.imgHeight)),e=document.getElementById("maskCanvas");e.width=Math.floor(this.viewer.imgWidth),e.height=Math.floor(this.viewer.imgHeight),e.getContext("2d").putImageData(s,0,0),this.viewer.annContext.putImageData(s,0,0),this.viewer.redraw()}decodeMask(t){const s=Math.floor(this.viewer.imgHeight),e=Math.floor(this.viewer.imgWidth);console.log("decoding mask");const a=new DataView(t.data),n=new Uint8Array(s*e),o=new Uint8ClampedArray(s*e*4);let c=0,r=0;for(let d=0;d<t.data.byteLength;d++){const v=a.getUint8(d);for(let l=0;l<8&&!(c>=e*s);l++)n[c]=v>>7-l&1,o[r+0]=255,o[r+1]=(1-n[c])*255,o[r+2]=255,o[r+3]=n[c]*255,c++,r+=4}return console.log(n),o}}function m(h,t){h==null&&console.log(`Broken assumption: ${t} is null`)}class f{constructor(t,s){i(this,"api");i(this,"div");i(this,"imgCanvas");i(this,"imgContext");i(this,"annCanvas");i(this,"annContext");i(this,"dispLCanvas");i(this,"dispLContext");i(this,"prev1LCanvas");i(this,"prev1LContext");i(this,"canvasFactor");i(this,"canvasWidth");i(this,"canvasHeight");i(this,"zoom",1);i(this,"dx",0);i(this,"dy",0);i(this,"alpha",.5);i(this,"clicks",[]);i(this,"imgWidth",0);i(this,"imgHeight",0);i(this,"_mouseDown",t=>{const[s,e]=this.imgAbsCoords(t),a=t.button==0,n=[Math.floor(s),Math.floor(e),a];this.clicks.push(n),this.api.sendClicks(this.clicks),console.log(this.clicks),console.log("you should have received the clicks"),this.drawClicks()});console.log("construct"),this.div=document.getElementById(t),m(this.div,"div"),console.log("factor"+s),this.canvasFactor=s,this.canvasHeight=this.canvasFactor*224,this.canvasWidth=this.canvasFactor*224,this.api=new w(this),this.imgCanvas=document.createElement("canvas"),this.annCanvas=document.createElement("canvas"),this.dispLCanvas=document.createElement("canvas"),this.imgContext=this.imgCanvas.getContext("2d"),this.annContext=this.annCanvas.getContext("2d"),this.dispLContext=this.dispLCanvas.getContext("2d"),this.prev1LCanvas=document.createElement("canvas"),this.prev1LContext=this.prev1LCanvas.getContext("2d");for(const e of[this.imgContext,this.annContext,this.dispLContext,this.prev1LContext])m(e,"context"),e.imageSmoothingEnabled=!1,e.lineWidth=2;this.div.appendChild(this.dispLCanvas),this.dispLCanvas.addEventListener("mousedown",this._mouseDown),this.dispLCanvas.addEventListener("contextmenu",e=>{e.preventDefault(),e.stopPropagation()})}putImage(t){this.clearDataCanvases(),this.resizeDataCanvases(t.width,t.height),this.imgContext.drawImage(t,0,0),this.redraw()}redraw(){this.dispLContext.clearRect(0,0,this.dispLCanvas.width,this.dispLCanvas.height),this._drawInDisplayAlias(this.imgCanvas),this.dispLContext.globalAlpha=this.alpha,this._drawInDisplayAlias(this.annCanvas),this._drawInDisplayAlias(this.prev1LCanvas),this.dispLContext.globalAlpha=1}clearDataCanvases(){this.imgContext.clearRect(0,0,this.imgCanvas.width,this.imgCanvas.height),this.annContext.clearRect(0,0,this.annCanvas.width,this.annCanvas.height)}resizeDataCanvases(t,s){this.imgCanvas.width=t,this.imgCanvas.height=s,this.annCanvas.width=t,this.annCanvas.height=s,this.canvasWidth=t,this.canvasHeight=s,this.dispLCanvas.width=this.canvasWidth,this.dispLCanvas.height=this.canvasHeight,this.prev1LCanvas.width=this.canvasWidth,this.prev1LCanvas.height=this.canvasHeight,this.zoom=Math.min(this.canvasWidth/t,this.canvasHeight/s),this.dx=(this.canvasWidth-t*this.zoom)/2,this.dy=(this.canvasHeight-s*this.zoom)/2}_drawInDisplayAlias(t){this.dispLContext.drawImage(t,this.dx,this.dy,t.width*this.zoom,t.height*this.zoom)}handleImage(t){console.log("handle image"),this.imgContext.clearRect(0,0,this.imgCanvas.width,this.imgCanvas.height),this.putImage(t),this.imgHeight=t.height,this.imgWidth=t.width}drawClicks(){const t="rgb(0, 255, 0)",s="rgb(255, 0, 0)";this.clicks.forEach(e=>{this.prev1LContext.fillStyle=e[2]?t:s,this.prev1LContext.fillRect(e[0]-5,e[1]-5,10,10)}),this.redraw()}imgRelCoords(t){const s=t.offsetX,e=t.offsetY,a=this.imgCanvas.width*this.zoom,n=this.imgCanvas.height*this.zoom,o=(s-this.dx)/a,c=(e-this.dy)/n;return[o,c]}imgAbsCoords(t){const s=t.offsetX,e=t.offsetY,a=(s-this.dx)/this.zoom,n=(e-this.dy)/this.zoom;return[a,n]}}let g=new Image;const u=new Date().getTime();g.src=`http://localhost:8001?timestamp=${u}`;const x=new f("viewer1",1);console.log("reset");g.addEventListener("load",()=>x.handleImage(g));
